<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Calendar</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px;}
        .container{max-width:1200px;margin:0 auto;background:white;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,0.1);}
        .header{background:linear-gradient(135deg,#2c3e50,#34495e);color:white;padding:30px;text-align:center;}
        .student-info{display:flex;justify-content:space-between;align-items:center;padding:20px 30px;background:#f8f9fa;border-bottom:1px solid #e9ecef;}
        .student-avatar{width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;color:white;font-size:24px;font-weight:bold;}
        .month-selector{display:flex;align-items:center;gap:15px;}
        .month-btn{background:#007bff;color:white;border:none;padding:10px 15px;border-radius:8px;cursor:pointer;}
        .current-month{font-size:18px;font-weight:bold;color:#2c3e50;}
        .calendar-container{padding:30px;}
        .calendar-header{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-bottom:20px;}
        .day-header{text-align:center;font-weight:bold;background:#f8f9fa;padding:15px;border-radius:10px;}
        .calendar-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;}
        .calendar-day{aspect-ratio:1;display:flex;flex-direction:column;align-items:center;justify-content:center;border-radius:15px;cursor:pointer;border:2px solid transparent;transition:0.25s;}
        .calendar-day:hover{transform:scale(1.05);}
        .present{background:#27ae60;color:white;}
        .absent{background:#e74c3c;color:white;}
        .partial{background:#e67e22;color:white;}
        .holiday{background:#8e44ad;color:white;}
        .future{background:#f8f9fa;color:#6c757d;border:2px dashed #dee2e6;}
        .today{border:3px solid #007bff;}
        .empty{background:transparent;border:none;cursor:default;}
        .stats-container{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-top:30px;}
        .stat-card{background:#667eea;color:white;padding:25px;border-radius:15px;text-align:center;}
        .attendance-percentage{background:#27ae60;}
        .back-link{text-align:center;margin:25px;}
        .back-link a{color:#667eea;font-weight:600;border:2px solid #667eea;padding:10px 20px;border-radius:10px;text-decoration:none;}
    </style>
</head>
<body>

<div class="container">
    <div class="header"><h1>üìÖ Attendance Calendar</h1></div>

    <div class="student-info">
        <div style="display:flex;gap:20px;align-items:center;">
            <div class="student-avatar" id="studentAvatar">?</div>
            <div>
                <h3 id="studentName">Loading...</h3>
                <p id="studentRoll">Roll Number: Loading...</p>
            </div>
        </div>
        <div class="month-selector">
            <button class="month-btn" onclick="prevMonth()">‚Üê Previous</button>
            <div class="current-month" id="currentMonth">Loading...</div>
            <button class="month-btn" onclick="nextMonth()">Next ‚Üí</button>
        </div>
    </div>

    <div class="calendar-container">
        <div class="calendar-header">
            <div class="day-header">Sun</div><div class="day-header">Mon</div><div class="day-header">Tue</div>
            <div class="day-header">Wed</div><div class="day-header">Thu</div><div class="day-header">Fri</div>
            <div class="day-header">Sat</div>
        </div>
        <div class="calendar-grid" id="calendarGrid"></div>
    </div>

    <div class="stats-container">
        <div class="stat-card attendance-percentage"><div id="attendancePercentage" style="font-size:2em;font-weight:bold">0%</div>Attendance</div>
        <div class="stat-card"><div id="presentDays" style="font-size:2em;font-weight:bold">0</div>Present</div>
        <div class="stat-card"><div id="absentDays" style="font-size:2em;font-weight:bold">0</div>Absent</div>
        <div class="stat-card"><div id="totalEffectiveDays" style="font-size:2em;font-weight:bold">0</div>Effective Days</div>
        <div class="stat-card"><div id="needFor80" style="font-size:2em;font-weight:bold">-</div>Need for 80%</div>
    </div>

    <div class="back-link"><a href="index.html">‚Üê Back</a></div>
</div>


<!-- üî• Lecture-wise Attendance Modal -->
<div id="lectureModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
background:rgba(0,0,0,0.55); justify-content:center; align-items:center; z-index:999;">
    <div style="background:white; padding:25px; border-radius:15px; width:400px; max-height:80vh; overflow-y:auto;">
        <h2 style="text-align:center;">Lecture-wise Attendance</h2>
        <p id="modalDate" style="text-align:center; font-weight:bold; margin-bottom:15px;"></p>
        <div id="lectureList"></div>
        <button onclick="closeLectureModal()" style="margin-top:20px;width:100%;padding:10px;
        background:#667eea;color:white;border-radius:10px;border:none;cursor:pointer;">Close</button>
    </div>
</div>

<script>
const API_BASE_URL = "http://localhost:8000";

let now = new Date();
let currentMonth = now.getMonth();
let currentYear = now.getFullYear();

let studentRollNumber = null;
let studentName = null;
let attendanceData = {};
let holidays = new Set();
let festivalHolidays = new Set();
let useSundayHoliday = JSON.parse(localStorage.getItem("useSundayHoliday")) ?? true;
let totalSemesterDays = null;

document.addEventListener("DOMContentLoaded", async () => {
    const q = new URLSearchParams(location.search);
    studentRollNumber = q.get("roll_number") || localStorage.getItem("studentRollNumber");
    studentName = localStorage.getItem("studentName") || "Student";
    loadStudentInfo();
    await loadHolidaySettings();
    loadAttendance();
});

function loadStudentInfo() {
    document.getElementById("studentName").textContent = studentName;
    document.getElementById("studentRoll").textContent = `Roll Number: ${studentRollNumber}`;
    document.getElementById("studentAvatar").textContent = studentName[0]?.toUpperCase() ?? "?";
}

async function loadHolidaySettings() {
    const [manual, festivals, total] = await Promise.all([
        fetch(`${API_BASE_URL}/admin/holidays`).then(r => r.json()),
        fetch(`${API_BASE_URL}/admin/holidays/default_festivals`).then(r => r.json()),
        fetch(`${API_BASE_URL}/admin/settings/total_days`).then(r => r.json())
    ]);
    holidays = new Set(manual.holidays || []);
    festivalHolidays = new Set(festivals.default_festivals || []);
    totalSemesterDays = total.total_days || null;
}

async function loadAttendance() {
    attendanceData = {};
    const last = new Date(currentYear, currentMonth + 1, 0).getDate();
    const q = [];
    for (let d = 1; d <= last; d++) {
        const key = `${String(d).padStart(2,'0')}_${String(currentMonth + 1).padStart(2,'0')}_${currentYear}`;
        q.push(getAttendanceForDate(key, d));
    }
    await Promise.all(q);
    renderCalendar();
    updateStats();
}

async function getAttendanceForDate(dateStr, day) {
    const date = new Date(currentYear, currentMonth, day);

    if (useSundayHoliday && date.getDay() === 0)
        return attendanceData[day] = { status: "holiday", date: dateStr };

    if (holidays.has(dateStr) || festivalHolidays.has(dateStr))
        return attendanceData[day] = { status: "holiday", date: dateStr };

    try {
        const res = await fetch(`${API_BASE_URL}/attendance?roll_number=${studentRollNumber}&date=${dateStr}`);
        attendanceData[day] = res.ok ? (await res.json()).attendance : null;
    } catch {
        attendanceData[day] = null;
    }
}

function renderCalendar() {
    const grid = document.getElementById("calendarGrid");
    grid.innerHTML = "";

    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    for (let i = 0; i < firstDay; i++) grid.innerHTML += `<div class="calendar-day empty"></div>`;

    const last = new Date(currentYear, currentMonth + 1, 0).getDate();
    const today = new Date();

    for (let d = 1; d <= last; d++) {
        const box = document.createElement("div");
        box.classList.add("calendar-day");
        const rec = attendanceData[d];

        const isFuture = new Date(currentYear, currentMonth, d) > today;
        const isToday = d === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear();

        if (rec && rec.status.toLowerCase().includes("holiday")) box.classList.add("holiday");
        else if (isFuture) box.classList.add("future");
        else if (rec) {
            let s = rec.status.toLowerCase();
            if (s.includes("present") || s === "p") box.classList.add("present");
            else if (s.includes("partial") || s === "pt") box.classList.add("partial");
            else box.classList.add("absent");
        } else box.classList.add("absent");

        if (isToday) box.classList.add("today");

        box.innerHTML = `
            <div style="font-size:18px;font-weight:bold">${d}</div>
            <div>${rec ? rec.status.toUpperCase() : (isFuture ? "" : "ABSENT")}</div>
        `;

        if (!isFuture && rec && !rec.status.toLowerCase().includes("holiday")) {
            if (rec.status.toLowerCase().includes("partial"))
                box.onclick = () => showLectureDetails(rec.date);
            else box.onclick = () => alert(`${rec.date} ‚ûú ${rec.status.toUpperCase()}`);
        }

        grid.appendChild(box);
    }

    document.getElementById("currentMonth").textContent =
        `${new Date(currentYear, currentMonth).toLocaleString('default', { month: 'long' })} ${currentYear}`;
}

function updateStats() {
    let present = 0, absent = 0, effective = 0;
    const last = new Date(currentYear, currentMonth + 1, 0).getDate();

    for (let d = 1; d <= last; d++) {
        const rec = attendanceData[d];
        if (!rec || rec.status === "holiday") continue;
        effective++;
        if (rec.status === "present") present++;
        else absent++;
    }

    attendancePercentage.textContent = effective ? `${Math.round((present / effective) * 100)}%` : "0%";
    presentDays.textContent = present;
    absentDays.textContent = absent;
    totalEffectiveDays.textContent = effective;
    needFor80.textContent = totalSemesterDays ? Math.max(0, Math.ceil(totalSemesterDays * .8) - present) : "-";
}

/* ==========================================================
   üî• NEW ‚Äî Lecture-wise attendance using admin DB table
========================================================== */
function closeLectureModal() {
    document.getElementById("lectureModal").style.display = "none";
}

async function showLectureDetails(dateStr) {
    document.getElementById("lectureModal").style.display = "flex";
    document.getElementById("modalDate").textContent = dateStr;

    const lectureList = document.getElementById("lectureList");
    lectureList.innerHTML = "Loading...";

    try {
        const res = await fetch(`${API_BASE_URL}/admin/attendance_by_date?date=${dateStr}`);
        const data = await res.json();
        const students = data.students || [];

        const student = students.find(s => String(s.roll_number) === String(studentRollNumber));
        if (!student) {
            lectureList.innerHTML = `<p style='color:red;'>No record found for this student</p>`;
            return;
        }

        const lec = student.lectures || {};

        lectureList.innerHTML = "";
        for (let n = 1; n <= 6; n++) {
            const key = `L_${n}`;
            const status = String(lec[key] || 'A').toLowerCase();
            let color = "#e74c3c";
            if (status === "p") color = "#27ae60";

            const div = document.createElement("div");
            div.style = `
                padding:10px; margin:8px 0; border-radius:10px;
                color:white; font-weight:bold; background:${color};
                display:flex; justify-content:space-between;
            `;
            div.innerHTML = `
                <span>Lecture ${n}</span>
                <span>${status.toUpperCase()}</span>
            `;
            lectureList.appendChild(div);
        }

    } catch (err) {
        lectureList.innerHTML = "<p style='color:red;'>Error loading lecture details</p>";
    }
}

function prevMonth(){currentMonth--;if(currentMonth<0){currentMonth=11;currentYear--;}loadAttendance();}
function nextMonth(){currentMonth++;if(currentMonth>11){currentMonth=0;currentYear++;}loadAttendance();}

</script>

</body>
</html>
